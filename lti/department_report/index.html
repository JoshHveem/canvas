<!doctype html>
<html>

<head>
  <title>Department Report</title>
  <link rel="stylesheet" href="/canvas/lti/department_report/style/main.css">
  <script src="/canvas/lti/cookies.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.5.0/print.js"></script>
</head>

<body>
  <div 
    style='visibility: hidden;'
    id='canvas-department-report-vue'>
    <div v-if="loading">
      <span>Loading...</span>
    </div>
    <div v-else>
      <div style='position: sticky; width: 100%; background-color: #fff; z-index: 10; padding: 4px; box-sizing: border-box; box-shadow: 0px 5px 5px #888; margin-bottom: 1rem; top: 0;'>
          <div style='display: inline-block;'>
            Grade: 
            <span class='btech-pill-text' :style='{"background-color": colors.red, "color": "#fff"}'>0-59%</span>
            <span class='btech-pill-text' :style='{"background-color": colors.orange, "color": "#fff"}'>60-79%</span>
            <span class='btech-pill-text' :style='{"background-color": colors.yellow, "color": "#fff"}'>80-89%</span>
            <span class='btech-pill-text' :style='{"background-color": colors.green, "color": "#fff"}'>90-100%</span>
            <br>
            <br>
            <div
              v-show='showProgressRatio'
            >
              SAP:
              <span class='btech-pill-text' :style='{"background-color": colors.red, "color": "#fff"}'>&gt;150%</span>
              <span class='btech-pill-text' :style='{"background-color": colors.yellow, "color": "#fff"}'>101-150%</span>
              <span class='btech-pill-text' :style='{"background-color": colors.green, "color": "#fff"}'>0-100%</span>
            </div>
          </div>
          <div style='display: inline-block;'>
            Submission History:
            <span class='btech-pill-text' :style='{"background-color": colors.red, "color": "#fff"}'>&gt;10 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.yellow, "color": "#fff"}'>7-9 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.green, "color": "#fff"}'>0-7 days</span>
            <br>
            <br>
            Course Enrollment:
            <span class='btech-pill-text' :style='{"background-color": colors.red, "color": "#fff"}'>&gt;180 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.orange, "color": "#fff"}'>121-180 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.yellow, "color": "#fff"}'>61-120 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.green, "color": "#fff"}'>0-60 days</span>
            <span class='btech-pill-text' :style='{"background-color": colors.complete, "color": "#fff"}'>Completed</span>
            <span class='btech-pill-text' :style='{"background-color": colors.gray, "color": "#000"}'>No Enrollment Found</span>
          </div>
          <div style='padding-top: 2rem;'><strong>WARNING: </strong>The SAP provided in this report is an estimation and not the student's official SAP.</div>
      </div>
      <div v-show='showStudent==="all"'>
        <select @change='loadDepartmentUsers' v-model='currentDepartment'>
          <option v-for='department in availableDepartments' :value='department'>
            {{json.dept_code_to_name[department].name + " (" + json.dept_code_to_name[department].first_year + "-" + json.dept_code_to_name[department].last_year + ")"}}
          </option>
        </select>
        <div v-for='(users, year) in usersByYear' :key='year'>
          <div v-if='users.length > 0'>
            <h2
              class='btech-tree-header'
            >{{year}} {{currentDepartment}} Tree</h2>
            <div 
              v-for='user in users' 
              :key='user.id'
              class='btech-user-container'
              >
              <div>
                <div>
                  <div @click='showStudent=user; console.log(showStudent); showStudent.year = year; openStudentReport(json.users[user.id].canvas_id, user.id);' class='btech-user-name' style='width: 180px; display: inline-block; font-size: 1rem; cursor: pointer;'>
                    <strong>{{user.name}}</strong>
                  </div>
                  <div style='display: inline-block; width: 6rem; font-size: 1rem;'>
                    <span>Grade: </span>
                    <span 
                    class='btech-pill-text'
                    :style="{
                        'background-color': calcDepartmentScoreColorBg(user),
                        'color': calcDepartmentScoreColorFont(user),
                      }">
                      {{calcDepartmentScoreText(user)}}
                    </span>
                  </div>
                  <div style='display: inline-block; width: 6rem; font-size: 1rem;'>
                    <span>SAP</span>
                    <span 
                    class='btech-pill-text'
                    :style="{
                        'background-color': calcDepartmentTimeColorBg(user),
                        'color': '#ffffff',
                      }">
                      {{calcDepartmentTimeText(user)}} 
                    </span>
                  </div>
                  <div :id="'btech-user-submission-summary-' + user.canvas_id"
                    style="display: inline-block;"
                  >
                    . . .
                  </div>
                </div>

                <div 
                  style='padding-top: 0.25rem; padding-bottom: 0.25rem;'
                  v-for="courseType in json['trees'][currentDepartment][year]['courses']"
                >
                  <div>{{courseType}}</div>
                  <div v-for="(course, course_code) in json['trees'][currentDepartment][year]['courses'][courseType]" class='btech-course-progress-bar'
                    :title="course.name"
                    :style="
                    {
                      'background-color': colors.base,
                    }
                  ">
                    <a 
                      :class="{
                        disabled: users.courses[course_code].course_id === null
                      }" 
                      :href="'https://btech.instructure.com/courses/' + users.courses[course_code].course_id + '/grades/' + user.canvas_id"
                      target="_blank">
                      <div class='btech-course-progress-bar-fill' :style="
                      {
                        'background-color': getCourseProgressBarColor(user, course, course_code),
                        width: 100 + '%'
                      }
                      ">
                      </div>
                      <div v-if="course.progress > 0" style="color: #FFFFFF" class='btech-course-progress-bar-text'>
                        {{course_code}}
                      </div>
                      <div v-else style="color: #000000" class='btech-course-progress-bar-text'>
                        {{course_code}}
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-show='showStudent !== "all"' id='printable-report' class='btech-modal' style='display: inline-block; background-color: #fff; padding: 0.5rem;'>
       </div> 
    </div>
  </div>
  <script>
    const CURRENT_DEPARTMENT = getCookie('currentDepartment');
    var scr = document.createElement('script'),
      head = document.head || document.getElementsByTagName('head')[0];
    scr.src = '/canvas/lti/department_report/report.js';
    scr.async = false; // optionally

    head.insertBefore(scr, head.firstChild);
  </script>
</body>

</html>