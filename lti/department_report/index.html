<!doctype html>
<html>

<head>
  <link rel="stylesheet" href="/canvas/lti/department_report/style/main.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
</head>

<body>
  <div 
    id='canvas-department-report-vue'>
    <div v-if="loading">
      <span>Loading...</span>
    </div>
    <div v-else>
      <select @change='loadDepartmentUsers' v-model='currentDepartment'>
        <option v-for='department in availableDepartments' :value='department'>
          {{json.dept_code_to_name[department].name + " (" + json.dept_code_to_name[department].first_year + "-" + json.dept_code_to_name[department].last_year + ")"}}
        </option>
      </select>
      <div v-for='(users, year) in usersByYear' :key='year'>
        <div v-if='users.length > 0'>
          <h2
            class='btech-tree-header'
          >{{year}} {{currentDepartment}} Tree</h2>
          <div 
            v-for='user in users' 
            :key='user.id'
            class='btech-user-container'
            >
            <div>
              <div>
                <div class='btech-user-name' style='width: 180px; display: inline-block; font-size: 1rem;'>
                  <a :href="'https://btech.instructure.com/users/' + json.sis_to_canv[user.id].canvas_id" target="_blank">
                    <strong>{{user.name}}</strong>
                  </a>
                </div>
                <div style='display: inline-block; width: 3rem; font-size: 1rem;'>
                  <span :style="{
                'background-color': calcDepartmentScoreColorBg(user),
                'color': calcDepartmentScoreColorFont(user),
                'padding': '4px',
                'border-radius': '10px',
                'font-size': '.75rem'
              }">
                    {{calcDepartmentScoreText(user)}}
                  </span>
                </div>
                <div :id="'btech-user-submission-summary-' + json.sis_to_canv[user.id].canvas_id"
                  style="display: inline-block; cursor: pointer;"
                  @click='openStudentReport(json.sis_to_canv[user.id].canvas_id, user.id);'>
                  . . .
                </div>
              </div>

              <div 
                style='padding-top: 0.25rem; padding-bottom: 0.25rem;'
                v-for='courseType in courseTypes'>
                <div v-if='user[courseType].length > 0'>
                  <div v-for='(course) in user[courseType]' class='btech-course-progress-bar'
                    :title="json['progress'][currentDepartment][year]['base'][course.code].name" :key='course.code'
                    :style="
                    {
                      'background-color': colors.base,
                    }
                  ">
                    <a 
                      :class="{
                        disabled: course.course_id === null
                      }" 
                      :href="'https://btech.instructure.com/courses/' + course.course_id + '/grades/' + json.sis_to_canv[user.id].canvas_id"
                      target="_blank">
                      <div class='btech-course-progress-bar-fill' :style="
                      {
                        'background-color': getCourseProgressBarColor(course),
                        width: 100 + '%'
                      }
                    ">
                      </div>
                      <div v-if="course.progress > 0" style="color: #FFFFFF" class='btech-course-progress-bar-text'>
                        {{course.code}}
                      </div>
                      <div v-else style="color: #000000" class='btech-course-progress-bar-text'>
                        {{course.code}}
                      </div>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-show='showStudentReport' class='btech-modal' style='display: inline-block;'>
        <div class='btech-modal-content'>
          <div class="btech-tabs">
            <ul>
              <li @click="menu='report'">Submissions</li>
              <li @click="menu='period'"></li>
              <li style='float: right;' v-on:click='closeStudentReport()'>X</li>
            </ul>
          </div>
          <div class='btech-modal-content-inner'>
            <div id='btech-department-report-student-submissions-graph'>Loading...</div>
          </div>
        </div>
      </div>
    </div>

  </div>
  <script>
    var CANVAS_LTI_DATA = <%-JSON.stringify(canvas_lti_data) %>;
    const CURRENT_DEPARTMENT = CANVAS_LTI_DATA.custom_canvas_account_id;
    var scr = document.createElement('script'),
      head = document.head || document.getElementsByTagName('head')[0];
    scr.src = '/canvas/lti/department_report/report.js';
    scr.async = false; // optionally

    head.insertBefore(scr, head.firstChild);
  </script>
</body>

</html>