<!doctype html>
<html>

<head>
  <title>Department Report</title>
  <link rel="stylesheet" href="/canvas/lti/department_report/style/main.css">
  <script src="/canvas/lti/cookies.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="/canvas/lti/department_report/components/courseProgressBarInd.js"></script>
  <script src="/canvas/lti/department_report/components/courseRowInd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.5.0/print.js"></script>
</head>

<body>
  <div style="visibility: hidden;" id="canvas-department-report-vue">
    <div v-if="loading">
      <span>Loading...</span>
    </div>
    <div v-else>
      <div
        style="position: sticky; width: 100%; background-color: #fff; z-index: 10; padding: 4px; box-sizing: border-box; box-shadow: 0px 5px 5px #888; margin-bottom: 1rem; top: 0;">
        <div style="display: inline-block;">
          Grade:
          <span class="btech-pill-text" :style="{'background-color': colors.red, 'color': '#fff'}">0-59%</span>
          <span class="btech-pill-text" :style="{'background-color': colors.yellow, 'color': '#fff'}">60-79%</span>
          <span class="btech-pill-text" :style="{'background-color': colors.green, 'color': '#fff'}">80-100%</span>
          <br>
          <br>
          <div v-show="showProgressRatio">
            SAP:
            <span class="btech-pill-text" :style="{'background-color': colors.red, 'color': '#fff'}">&gt;150%</span>
            <span class="btech-pill-text" :style="{'background-color': colors.yellow, 'color': '#fff'}">101-150%</span>
            <span class="btech-pill-text" :style="{'background-color': colors.green, 'color': '#fff'}">0-100%</span>
          </div>
        </div>
        <div style="display: inline-block;">
          Submission History:
          <span class="btech-pill-text" :style="{'background-color': colors.red, 'color': '#fff'}">&gt;10 days</span>
          <span class="btech-pill-text" :style="{'background-color': colors.yellow, 'color': '#fff'}">7-9 days</span>
          <span class="btech-pill-text" :style="{'background-color': colors.green, 'color': '#fff'}">0-7 days</span>
          <br>
          <br>
          Course Enrollment:
          <span class="btech-pill-text" :style="{'background-color': colors.red, 'color': '#fff'}">&gt;180 days</span>
          <span class="btech-pill-text" :style="{'background-color': colors.yellow, 'color': '#fff'}">91-180 days</span>
          <span class="btech-pill-text" :style="{'background-color': colors.green, 'color': '#fff'}">0-90 days</span>
          <span class="btech-pill-text" :style="{'background-color': colors.complete, 'color': '#fff'}">Completed</span>
          <span class="btech-pill-text" :style="{'background-color': colors.gray, 'color': '#000'}">No Enrollment
            Found</span>
        </div>
        <div style="padding-top: 1rem;">
          <p><strong>DISCLAIMER: </strong>
          All data presented is an estimation and will NOT include submissions from the current day. Not intended for official use.</p>
          <p>Email Josh (jhveem@btech.edu) with any questions or suggestsions.</p>
        </div>
      </div>
      <div v-show="showStudent==='all'">
        <select @change="loadDepartmentUsers" v-model="currentDepartment">
          <option v-for="department in availableDepartments" :value="department">
            {{json.dept_code_to_name[department].name + " (" + json.dept_code_to_name[department].first_year + "-" + json.dept_code_to_name[department].last_year + ")"}}
          </option>
        </select>
        <div v-for="(users, year) in usersByYear" :key="year">
          <div v-if="users.length > 0">
            <h2 class="btech-tree-header">{{year}} {{currentDepartment}} Tree</h2>
            <div v-for="user in users" :key="user.id" class="btech-user-container">
              <div>
                <div>
                  <div
                    @click="showStudent=user; console.log(showStudent); showStudent.year = year; openStudentReport(json.users[user.id].canvas_id, user.id);"
                    class="btech-user-name"
                    style="width: 180px; display: inline-block; font-size: 1rem; cursor: pointer;">
                    <strong>{{user.name}}</strong>
                  </div>
                  <div style="display: inline-block; width: 6rem; font-size: 1rem;">
                    <span>Grade</span>
                    <span class="btech-pill-text" :style="{
                        'background-color': calcDepartmentScoreColorBg(user),
                        'color': calcDepartmentScoreColorFont(user),
                      }">
                      {{calcDepartmentScoreText(user)}}
                    </span>
                  </div>
                  <div style="display: inline-block; width: 6rem; font-size: 1rem;">
                    <span>SAP</span>
                    <span 
                      v-if='user.enrolledHours > 0'
                      class="btech-pill-text" 
                      :style="{
                        'background-color': calcDepartmentTimeColorBg(user),
                        'color': '#ffffff',
                      }">
                      {{calcDepartmentTimeText(user)}}
                    </span>
                    <span 
                      v-else
                      class="btech-pill-text" 
                      :style="{
                        'background-color': colors.gray,
                        'color': '#000000',
                      }">
                      N/A 
                    </span>
                  </div>
                  <div 
                    v-if="false"
                    style="display: inline-block; width: 8rem; font-size: 1rem;">
                    <span>Progress</span>
                    <span class="btech-pill-text" :style="{
                        'background-color': colors.gray,
                        'color': '#000000',
                      }">
                      {{Math.round((user.completedHours / json.trees[currentDepartment][year].hours) * 100)}}%
                    </span>
                  </div>
                  <div :id="'btech-user-submission-summary-' + json.users[user.id].canvas_id"
                    style="display: inline-block;">
                    . . .
                  </div>
                </div>

                <div
                  v-for="(courses, courseType) in json['trees'][currentDepartment][year]['courses']"
                >
                  <div 
                    style="padding-top: 0.25rem; padding-bottom: 0.25rem;"
                  >
                    <div 
                        v-if="courseType==='elective' && user.elective.length===0 && Object.keys(json['trees'][currentDepartment][year]['courses'].elective).length > 0"
                        style="font-size: .75rem;"
                      >
                      No Elective Enrollments Found
                    </div>
                    <div 
                      v-for="(course, course_code) in courses" 
                      class="btech-course-progress-bar" :title="course.name"
                      :style="
                      {
                        'background-color': colors.base,
                        'display': checkIncludeCourse(courseType, (courseType==='core' || course_code in json.users[user.id].courses))
                      }
                    ">
                      <a :class="{disabled: !(course_code in json.users[user.id].courses)}"
                        :href="getCourseURL(user, course_code)" target="_blank">
                        <div class="btech-course-progress-bar-fill" :style="
                        {
                          'background-color': getCourseProgressBarColor(user, course, course_code, courseType),
                          width: 100 + '%'
                        }
                        ">
                        </div>
                        <div v-if="course_code in json.users[user.id].courses" style="color: #FFFFFF"
                          class="btech-course-progress-bar-text">
                          {{course_code}}
                        </div>
                        <div v-else style="color: #000000" class="btech-course-progress-bar-text">
                          {{course_code}}
                        </div>
                      </a>
                    </div>
                  </div>
                  <div v-if="courseType==='core' && Object.keys(json['trees'][currentDepartment][year]['courses'].elective).length > 0" style="border-bottom: 1px solid #AAA;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div 
        v-show="showStudent !== 'all'" 
        id="printable-report" 
        class="btech-modal"
        style="display: inline-block; background-color: #fff; padding: 0.5rem;"
      >
        <div class="btech-pill-text print-hide"
          :style="{'background-color': colors.red, 'color': '#fff', 'width': '1rem', 'float': 'right', 'text-align': 'center', 'cursor': 'pointer'}"
          @click="closeStudentReport()">
          X
        </div>
        <div class="btech-pill-text print-hide"
          title="You may have to enable printing background graphics for everything to appear."
          :style="{'background-color': colors.gray, 'color': '#000', 'width': '2.5rem', 'float': 'right', 'text-align': 'center', 'cursor': 'pointer'}"
          @click="print()">
          Print
        </div>

        <div v-if="showStudent !== 'all'">
          <div style="margin-bottom: 2rem;">
            <div class="btech-user-name" style="margin-bottom: .25rem;">
              <div style="display: inline-block; width: 12rem; font-size: 1rem;">
                <a :href="'https://btech.instructure.com/users/' + json.users[showStudent.id].canvas_id"
                  target="_blank">
                  <strong>{{json.users[showStudent.id].name}} ({{showStudent.id}})</strong>
                </a>
              </div>
              <span>
                Average Grade
              </span>
              <div style="display: inline-block; width: 3rem; font-size: 1rem;">
                <span class="btech-pill-text" :style="{
                    'background-color': calcDepartmentScoreColorBg(showStudent),
                    'color': calcDepartmentScoreColorFont(showStudent),
                  }">
                  {{calcDepartmentScoreText(showStudent)}}
                </span>
              </div>
              <div style="display: inline-block; width: 6rem; font-size: 1rem;">
                <span>
                  SAP
                </span>
                <div style="display: inline-block; width: 3rem; font-size: 1rem;">
                  <span class="btech-pill-text" :style="{
                      'background-color': calcDepartmentTimeColorBg(showStudent),
                      'color': '#ffffff',
                    }">
                    {{calcDepartmentTimeText(showStudent)}}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="btech-department-report-student-hours">
          <div id="btech-department-report-student-progress-donut" style="float: left; position: relative;">Loading...
          </div>
          <div style="display: inline-block;">
            <div class="data-item">
              <span class="data-item-title">
                Certificate Hours:
              </span>
              <div v-if="showStudent!=='all'" style="display: inline-block; width: 4rem; font-size: 1rem;">
                <span class="btech-pill-text" :style="{
                    'background-color': colors.gray,
                    'color': '#000000',
                  }">
                  {{json.trees[currentDepartment][showStudent.year].hours}} hrs
                </span>
              </div>
            </div>
            <div class="data-item">
              <span class="data-item-title">
                Enrolled Hours:
              </span>
              <div style="display: inline-block; width: 4rem; font-size: 1rem;">
                <span class="btech-pill-text" :style="{
                  'background-color': colors.red,
                  'color': '#ffffff',
                }">
                  {{showStudent.enrolledHours}} hrs
                </span>
              </div>
            </div>
            <div class="data-item">
              <span class="data-item-title">
                Completed Hours:
              </span>
              <div style="display: inline-block; width: 4rem; font-size: 1rem;">
                <span class="btech-pill-text" :style="{
                  'background-color': colors.blue,
                  'color': '#ffffff',
                }">
                  {{showStudent.completedHours}} hrs
                </span>
              </div>
            </div>
          </div>
          <div class="btech-department-report-student-avatar">
            <img v-if="json.users[showStudent.id].avatar_url !== undefined" :src="showStudent.avatar_url">
          </div>
        </div>

        <div id="btech-department-report-student-submissions-graph">Loading...</div>

        <div v-if="showStudent !== 'all'">
          <div 
            style="padding-top: 0.25rem; padding-bottom: 0.25rem;"
            v-for="(courses, courseType) in json.trees[currentDepartment][showStudent.year]['courses']"
          >
            <span v-if="Object.keys(json['trees'][currentDepartment][showStudent.year]['courses'][courseType]).length > 0"><strong>{{courseType.toUpperCase()}}</strong></span>
            <div v-for="(course, courseCode) in courses">
              <course-row-ind
                :progress="getUserCourseProgress(showStudent.id, courseCode)"
                :colors="colors"
                :hours="json.users[showStudent.id].courses[courseCode]"
                :course="json.users[showStudent.id].courses[courseCode]"
                :course-name="course.name"
                :course-code="courseCode"
                :user-canvas-id="json.users[showStudent.id].canvas_id"
              ></course-row-ind>
            </div>
          </div>
          <div 
            style="padding-top: 0.25rem; padding-bottom: 0.25rem;"
          >
            <span><strong>OTHER</strong></span>
            <div v-for="course in showStudent.other">
              <course-row-ind
                v-if="(json.users[showStudent.id].courses[course.code].enabled || (json.users[showStudent.id].courses[course.code].state==='active'))"
                :progress="getUserCourseProgress(showStudent.id, course.code)"
                :colors="colors"
                :hours="json.users[showStudent.id].courses[course.code].hours"
                :course="json.users[showStudent.id].courses[course.code]"
                :course-name="json.users[showStudent.id].courses[course.code].name"
                :course-code="course.code"
                :user-canvas-id="json.users[showStudent.id].canvas_id"
              ></course-row-ind>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const CURRENT_DEPARTMENT = getCookie('currentDepartment');
    var scr = document.createElement('script'),
      head = document.head || document.getElementsByTagName('head')[0];
    scr.src = '/canvas/lti/department_report/report.js';
    scr.async = false; // optionally

    head.insertBefore(scr, head.firstChild);
  </script>
</body>

</html>